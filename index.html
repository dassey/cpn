<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive CPN Setup Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* Gray-200 background */
        }
        .step-header {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .step-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .step-section.active .step-content {
            max-height: 10000px; /* Large enough for content */
        }
        .step-section.active .chevron {
            transform: rotate(180deg);
        }
        .checklist-item {
            transition: all 0.2s ease-in-out;
            border-left: 4px solid #d1d5db;
        }
        .checklist-item.completed {
            background-color: #e7f5ed;
            border-left-color: #22c55e;
        }
        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            color: #6b7280;
        }
        .checklist-item.completed .checkbox-icon {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
        }
        .checkbox-icon {
            transition: all 0.2s ease-in-out;
        }
        .code-block {
            background-color: #1f2937;
            color: #d1d5db;
            font-family: 'Courier New', monospace;
            position: relative;
        }
        .code-block .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .code-block:hover .copy-btn {
            opacity: 1;
        }
        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #3b82f6;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .image-zoom-container {
            cursor: zoom-in;
            overflow: hidden;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        .modal-content img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        .phase-progress {
            background-color: #e5e7eb;
        }
        .phase-progress-bar {
            background-color: #3b82f6;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-200 text-gray-900">

    <!-- Header -->
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-satellite-dish text-4xl text-blue-400"></i>
                <div>
                    <h1 class="text-2xl font-bold">Comprehensive CPN Setup Guide</h1>
                    <p class="text-sm text-gray-300">AN/TTC-64D(V)3 | Interactive Field Manual</p>
                </div>
            </div>
            <button onclick="resetAllProgress()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                <i class="fas fa-sync-alt mr-2"></i>Reset Progress
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-4">
        <!-- Steps will be generated here by JavaScript -->
    </main>
    
    <!-- Image Zoom Modal -->
    <div id="image-modal" class="modal-backdrop" onclick="closeModal()">
        <span class="absolute top-5 right-8 text-white text-4xl font-bold cursor-pointer" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modal-image-content" src="" alt="Zoomed Image">
        </div>
    </div>

    <script>
        const guideData = {
            "1": {
                title: "Pre-Deployment & Safety",
                icon: "fa-clipboard-check",
                content: `
                    <p class="text-gray-600 mb-6">This phase covers critical safety procedures, personnel, and pre-deployment checks to ensure a smooth and safe setup process. Successful completion of this phase is mandatory before any equipment is unpacked.</p>
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-r-lg" role="alert">
                        <h3 class="font-bold text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>CRITICAL SAFETY WARNINGS (TM 11-5895-2060-13&P, WP 0001)</h3>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li><b>High Voltage:</b> Lethal voltages are present. Ensure proper grounding is established BEFORE connecting power. Follow lockout/tagout procedures.</li>
                            <li><b>RF Radiation Hazard:</b> Maintain safe distances from transmitting antennas. Refer to <span class="tooltip">TM<span class="tooltip-text">Technical Manual</span></span> for specific standoff distances.</li>
                            <li><b>Heavy Equipment:</b> Transit cases are a multi-person lift. Use proper lifting techniques and equipment to prevent injury.</li>
                            <li><b>COMSEC:</b> All classified materials and cryptographic keys must be handled in accordance with <span class="tooltip">COMSEC<span class="tooltip-text">Communications Security</span></span> protocols. Two-person integrity is required.</li>
                        </ul>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-users mr-2"></i>Required Personnel</h4>
                            <ul class="list-disc list-inside text-sm">
                                <li><b>Primary Team:</b> 25A (Signal Officer), 25B (IT Specialist), 25S (SATCOM Operator).</li>
                                <li><b>Support Team:</b> 91D (Power Generation), 88M (Motor Transport), Security Personnel.</li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                             <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-id-card mr-2"></i>Security Clearance Requirements</h4>
                             <ul class="list-disc list-inside text-sm">
                                <li><b>SECRET:</b> All personnel handling equipment.</li>
                                <li><b>TOP SECRET/SCI:</b> Personnel configuring SIPR networks and classified routing.</li>
                            </ul>
                        </div>
                    </div>
                `,
                checklist: [
                    { id: 'c1-1', text: 'Verify all required personnel and security clearances are present and validated.' },
                    { id: 'c1-2', text: 'Conduct full equipment inventory against COEI/BII lists. Document any deficiencies.' },
                    { id: 'c1-3', text: 'Obtain and verify all COMSEC materials (CIKs, FIREFLY keys, etc.) from the COMSEC custodian.' },
                    { id: 'c1-4', text: 'Review site survey, ASA, and network diagrams. Confirm PACE plan for power and communications.' }
                ]
            },
            "2": {
                title: "Site Selection & Physical Setup",
                icon: "fa-truck-ramp-box",
                content: `
                    <p class="text-gray-600 mb-6">Proper site selection, physical setup, and positioning of the transit cases are critical for successful CPN operation and signal integrity.</p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mb-6 rounded-r-lg" role="alert">
                        <h3 class="font-bold text-lg"><i class="fas fa-map-marked-alt mr-2"></i>Key Site Considerations (Draft_BNCPN.docx)</h3>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>Choose a flat, well-drained area clear of obstacles and major RF interference sources.</li>
                            <li>Ensure the site has a clear line-of-sight to the required satellite (typically south in CONUS).</li>
                            <li>Position for security and defensibility with clear ingress/egress routes.</li>
                        </ul>
                    </div>
                `,
                checklist: [
                    { id: 'c2-1', text: 'Unpack and position NIPR, SIPR, and Colorless cases according to the diagram. Orient cases with the "BACK" facing the operator.' },
                    { id: 'c2-2', text: 'Position UPS units and place respective equipment stacks on top. Do not block ventilation.' },
                    { id: 'c2-3', text: 'Place front and rear case covers to the side, ensuring they do not create a hazard.' }
                ]
            },
            "3": {
                title: "Power & Grounding",
                icon: "fa-bolt",
                content: `
                    <p class="text-gray-600 mb-6">Establishing a solid ground and following the correct power-on sequence is essential to protect equipment and ensure personnel safety.</p>
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-r-lg" role="alert">
                        <h3 class="font-bold text-lg"><i class="fas fa-plug-circle-bolt mr-2"></i>Power & Grounding Protocol (TM 11-5895-2060-13&P, WP 0005)</h3>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li><b>Ground First:</b> Equipment cases MUST be grounded before any power is applied. Verify ground resistance is ≤10 ohms.</li>
                            <li><b>UPS is Primary:</b> Never plug equipment cases directly into a generator or shore power. Always route power through the UPS to protect against surges and provide battery backup.</li>
                            <li><b>Generator Load:</b> The CPN alone may not draw enough power to prevent wet stacking on larger generators. Add other loads if necessary.</li>
                        </ul>
                    </div>
                `,
                checklist: [
                    { id: 'c3-1', text: 'Install ground rods ≤ 8 feet from cases, drive until ~6 inches are exposed, and attach straps.' },
                    { id: 'c3-2', text: 'Connect all transit case ground straps to the E1 ground stud on each case\'s power strip.' },
                    { id: 'c3-3', text: 'Connect GFE power source (generator/shore) to the UPS inputs.' },
                    { id: 'c3-4', text: 'Connect NIPR, SIPR, and Colorless power strip cables into their corresponding UPS outputs.' },
                    { id: 'c3-5', text: 'Power ON the GFE source.' },
                    { id: 'c3-6', text: 'Set the rear panel INPUT POWER SWITCHES on all UPS units to ON.' },
                    { id: 'c3-7', text: 'Set the main power strip circuit breaker (CB1) in each transit case to ON.' }
                ]
            },
            "4": {
                title: "Cable Patching & Signal Flow",
                icon: "fa-ethernet",
                content: `
                    <p class="text-gray-600 mb-6">Accurate cable patching is critical for network connectivity. Follow these diagrams precisely, referencing the port numbers labeled on the equipment. Incorrect patching is a common point of failure.</p>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-semibold text-lg mb-2">Colorless Case Patching</h4>
                            <div class="bg-gray-100 p-4 rounded-lg image-zoom-container" onclick="zoomImage('https://i.imgur.com/k9b8jQG.png')">
                                <img src="https://i.imgur.com/k9b8jQG.png" alt="Colorless Case Patching Diagram" class="rounded-lg shadow-md border">
                            </div>
                            <div id="checklist-4-1" class="space-y-2 mt-4">
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-1-1', this, 1)"> ${getCheckboxIcon()} <span class="checklist-text"><b>G0/11:</b> Connect TFOCAII to NIPR TACLANE CT port.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-1-2', this, 1)"> ${getCheckboxIcon()} <span class="checklist-text"><b>G0/12:</b> Connect TFOCAII to SIPR TACLANE CT port.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-1-3', this, 1)"> ${getCheckboxIcon()} <span class="checklist-text"><b>G0/13:</b> Connect TFOCAII to STT Port J1 (for SATCOM).</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-1-4', this, 1)"> ${getCheckboxIcon()} <span class="checklist-text"><b>Mgmt:</b> Connect LAN Manager Laptop to Colorless Switch Port 1.</span></div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg mb-2">NIPR / SIPR Case Patching</h4>
                            <div class="bg-gray-100 p-4 rounded-lg image-zoom-container" onclick="zoomImage('https://i.imgur.com/9nJ5b8w.png')">
                                <img src="https://i.imgur.com/9nJ5b8w.png" alt="NIPR/SIPR Case Patching Diagram" class="rounded-lg shadow-md border">
                            </div>
                            <div id="checklist-4-2" class="space-y-2 mt-4">
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-2-1', this, 2)"> ${getCheckboxIcon()} <span class="checklist-text"><b>Mgmt:</b> Connect appropriate LAN Manager Laptop to Switch Port 1.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-2-2', this, 2)"> ${getCheckboxIcon()} <span class="checklist-text"><b>TACLANE PT:</b> Connect Switch Port G0/36 to TACLANE Plaintext (PT) Ethernet port.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-2-3', this, 2)"> ${getCheckboxIcon()} <span class="checklist-text"><b>Router Uplinks:</b> Connect Switch Ports 47 & 48 to Router Ports G0/0/1 & G0/0/0.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-2-4', this, 2)"> ${getCheckboxIcon()} <span class="checklist-text"><b>UCSE:</b> Connect Switch Ports 40, 41, 45 to UCSE GE2, GE3, and CIMC ports.</span></div>
                                <div class="checklist-item p-3 bg-white rounded-lg flex items-center cursor-pointer" onclick="toggleChecklistItem(4, 'c4-2-5', this, 2)"> ${getCheckboxIcon()} <span class="checklist-text"><b>TACLANE Console:</b> Connect LAN manager to front RJ45 console port of TACLANE for configuration.</span></div>
                            </div>
                        </div>
                    </div>
                `,
                checklist: []
            },
            "5": {
                title: "System & VM Initialization",
                icon: "fa-power-off",
                content: `
                    <p class="text-gray-600 mb-6">Follow this sequence to power on equipment and initialize the virtual environment. This process can take 10-20 minutes as virtual machines boot up.</p>
                `,
                checklist: [
                    { id: 'c5-1', text: 'Power on individual devices in NIPR/SIPR stacks (Router, Switch).' },
                    { id: 'c5-2', text: 'Check for a solid green light on the Cisco UCS-E server module to confirm server power-up (5-10 mins). If amber, press power button once. If still amber, access CIMC to power on host.'},
                    { id: 'c5-3', text: 'Power on individual devices in the Colorless stack (Router, Media Converter).'},
                    { id: 'c5-4', text: 'On the appropriate LAN Manager Laptop, launch vSphere Client and log into the ESXi host using the IP from your template.'},
                    { id: 'c5-5', text: 'Verify all required Virtual Machines (Call Manager, Riverbed, Firewall, etc.) show a green "play" icon in vSphere. If not, right-click and power them on.'}
                ]
            },
            "6": {
                title: "Network & Tunnel Configuration",
                icon: "fa-network-wired",
                content: `
                    <p class="text-gray-600 mb-6">This phase establishes the logical connections (tunnels) over the physical links. Accurate configuration is essential for routing traffic between the CPN and other network nodes like the JNN. Use your unit's ASA for all IP addresses and tunnel parameters.</p>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas-solid fa-code-branch mr-2"></i>Tunnel Configuration Workflow</h3>
                    <div class="bg-gray-100 p-4 rounded-lg border">
                       <img src="https://i.imgur.com/GzX22N3.png" alt="Tunnel Architecture" class="rounded-lg shadow-md border image-zoom-container" onclick="zoomImage(this.src)">
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mt-4 rounded-r-lg" role="alert">
                        <p>The tunnel build-up follows the OSI model. First, establish the physical link (Layer 1/2), then the encrypted link (Layer 2/3), and finally the logical IP routing (Layer 3).</p>
                    </div>
                `,
                checklist: [
                    { id: 'c6-1', text: 'Access the Colorless Router (XT2R) via console and verify OSPFv3 neighbors with the JNN XT2R using `show ospfv3 neighbor`.' },
                    { id: 'c6-2', text: 'Access the NIPR and SIPR TACLANEs and verify Security Associations (SAs) are established with their distant-end counterparts.' },
                    { id: 'c6-3', text: 'Access the NIPR Router (NT2R) and verify OSPFv2 neighbors over the tunnel using `show ip ospf neighbor`.' },
                    { id: 'c6-4', text: 'Access the SIPR Router (ST2R) and verify OSPFv2 neighbors over the tunnel using `show ip ospf neighbor`.' },
                    { id: 'c6-5', text: 'Configure and apply GAIT IVPN / Starshield settings if required by mission, following the detailed guide in the appendix.' }
                ]
            },
            "7": {
                title: "System Verification",
                icon: "fa-check-double",
                content: `
                    <p class="text-gray-600 mb-6">This final phase validates that all systems are communicating correctly and services are available to the end-user. Follow this specific sequence for a logical fault isolation process.</p>
                `,
                checklist: [
                    { id: 'c7-1', text: 'From the Colorless router (XT2R), ping the Linkway/STT modem IP to verify physical connectivity.' },
                    { id: 'c7-2', text: 'From the Colorless router (XT2R), ping the Cipher Text (CT) IP addresses of the NIPR and SIPR TACLANEs.' },
                    { id: 'c7-3', text: 'From the NIPR TACLANE (PT side), ping the NIPR router (NT2R).' },
                    { id: 'c7-4', text: 'From the SIPR TACLANE (PT side), ping the SIPR router (ST2R).' },
                    { id: 'c7-5', text: 'From the NIPR router (NT2R), ping the NIPR Management laptop.' },
                    { id: 'c7-6', text: 'From the SIPR router (ST2R), ping the SIPR Management laptop.' },
                    { id: 'c7-7', text: 'From a user device, perform a data check by browsing to a NIPR/SIPR website specified on the ASA.' },
                    { id: 'c7-8', text: 'From a user device, perform a voice check by making a call from a VoIP phone to a number specified on the ASA.' }
                ]
            },
            "8": {
                title: "Operations & Troubleshooting",
                icon: "fa-triangle-exclamation",
                content: `
                    <p class="text-gray-600 mb-6">This section provides quick-reference information for normal operations, shutdown procedures, and common troubleshooting tasks.</p>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-lg mb-2"><i class="fas fa-power-off mr-2"></i>Normal Shutdown Sequence</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm bg-gray-50 p-4 rounded-lg border">
                                <li>Ensure all users are disconnected from services.</li>
                                <li>Access vSphere and gracefully shut down all Virtual Machines.</li>
                                <li>Press the SRE Module SHUT DOWN button on NIPR/SIPR stacks; wait for amber light.</li>
                                <li>At the UPS front panel, press and hold F2, then press F3 to shut off the inverter.</li>
                                <li>At the UPS rear panel, turn OFF the AC Input Power switches.</li>
                                <li>Set all power strip circuit breakers (CB1) to OFF.</li>
                                <li>Disconnect signal cables, then power cables, then ground straps.</li>
                            </ol>
                        </div>
                        <div>
                            <h4 class="font-semibold text-lg mb-2"><i class="fas fa-key mr-2"></i>Cisco Password Recovery</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm bg-gray-50 p-4 rounded-lg border">
                                <li>Connect via console and reboot router.</li>
                                <li>Send <code class="bg-gray-200 p-1 rounded">Ctrl+Break</code> during startup to enter ROMMON.</li>
                                <li>Enter <code class="bg-gray-200 p-1 rounded">confreg 0x2142</code> then <code class="bg-gray-200 p-1 rounded">reset</code>.</li>
                                <li>Skip setup, <code class="bg-gray-200 p-1 rounded">enable</code>, then <code class="bg-gray-200 p-1 rounded">copy start run</code>.</li>
                                <li>Enter <code class="bg-gray-200 p-1 rounded">config t</code> and set a new password.</li>
                                <li>Set <code class="bg-gray-200 p-1 rounded">config-register 0x2102</code>.</li>
                                <li><code class="bg-gray-200 p-1 rounded">end</code> and <code class="bg-gray-200 p-1 rounded">copy run start</code>.</li>
                            </ol>
                        </div>
                    </div>
                `,
                checklist: []
            }
        };

        let activePhase = 1;
        let checklistStatus = {};

        function togglePhase(phaseId) {
            const section = document.getElementById(`phase-${phaseId}`);
            const content = section.querySelector('.step-content');
            
            // Close all other sections
            document.querySelectorAll('.step-section').forEach(s => {
                if (s.id !== `phase-${phaseId}`) {
                    s.classList.remove('active');
                }
            });

            // Toggle the clicked section
            section.classList.toggle('active');
        }
        
        function getCheckboxIcon() {
            return `<div class="checkbox-icon w-6 h-6 border-2 border-gray-400 rounded-md flex items-center justify-center mr-4 flex-shrink-0"><i class="fas fa-check text-base"></i></div>`;
        }
        
        function generateChecklist(phaseId, checklistItems, sublistId = 0) {
            if (!checklistItems || checklistItems.length === 0) return '';
            const listKey = sublistId > 0 ? `${phaseId}-${sublistId}` : `${phaseId}`;
            return `<div id="checklist-${listKey}" class="space-y-3 mt-6">` +
                checklistItems.map((item, index) => {
                    const itemId = item.id;
                    const isChecked = checklistStatus[phaseId] && checklistStatus[phaseId][itemId];
                    return `
                        <div class="checklist-item p-4 bg-white rounded-lg flex items-start cursor-pointer ${isChecked ? 'completed' : ''}" onclick="toggleChecklistItem(${phaseId}, '${itemId}', this)">
                            ${getCheckboxIcon()}
                            <span class="checklist-text">${item.text}</span>
                        </div>
                    `;
                }).join('') +
            `</div>`;
        }

        function renderGuide() {
            const mainContainer = document.querySelector('main');
            let html = '';
            for (const phaseId in guideData) {
                const phase = guideData[phaseId];
                html += `
                    <div id="phase-${phaseId}" class="step-section bg-gray-50 rounded-lg shadow-lg overflow-hidden">
                        <div class="step-header bg-white p-4 flex justify-between items-center border-b" onclick="togglePhase(${phaseId})">
                            <div class="flex items-center">
                                <div class="bg-blue-100 text-blue-600 rounded-full h-12 w-12 flex items-center justify-center text-xl font-bold mr-4">
                                    <i class="fas ${phase.icon}"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">${phase.title}</h2>
                                    <p class="text-sm text-gray-500">Phase ${phaseId} of ${Object.keys(guideData).length}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                               <div class="phase-progress w-32 h-2.5 rounded-full">
                                   <div id="progress-bar-${phaseId}" class="phase-progress-bar h-2.5 rounded-full" style="width: 0%"></div>
                               </div>
                               <i class="fas fa-chevron-down chevron transition-transform duration-300"></i>
                            </div>
                        </div>
                        <div class="step-content p-6">
                            ${phase.content}
                            ${generateChecklist(phaseId, phase.checklist)}
                        </div>
                    </div>
                `;
            }
            mainContainer.innerHTML = html;
            loadChecklistStatus();
            updateAllProgressBars();
            togglePhase(1); // Open the first phase by default
        }
        
        function updateProgressBar(phaseId) {
            const checklist = guideData[phaseId].checklist;
            const status = checklistStatus[phaseId] || {};
            const totalItems = checklist.length;
            if (totalItems === 0) {
                 document.getElementById(`progress-bar-${phaseId}`).style.width = '0%';
                 return;
            }
            const completedItems = Object.values(status).filter(v => v === true).length;
            const percentage = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
            const progressBar = document.getElementById(`progress-bar-${phaseId}`);
            if(progressBar) progressBar.style.width = `${percentage}%`;
        }

        function updateAllProgressBars() {
            for (const phaseId in guideData) {
                updateProgressBar(phaseId);
            }
        }
        
        function toggleChecklistItem(phaseId, itemId, element) {
            if (!checklistStatus[phaseId]) checklistStatus[phaseId] = {};
            checklistStatus[phaseId][itemId] = !checklistStatus[phaseId][itemId];
            element.classList.toggle('completed', checklistStatus[phaseId][itemId]);
            saveChecklistStatus();
            updateProgressBar(phaseId);
        }

        function saveChecklistStatus() {
            localStorage.setItem('cpnChecklistStatus_v3', JSON.stringify(checklistStatus));
        }

        function loadChecklistStatus() {
            const saved = localStorage.getItem('cpnChecklistStatus_v3');
            checklistStatus = saved ? JSON.parse(saved) : {};
             // Re-apply completed class based on loaded data
            document.querySelectorAll('.checklist-item').forEach(el => {
                const onclickAttr = el.getAttribute('onclick');
                const args = onclickAttr.match(/toggleChecklistItem\((\d+), '([^']+)'/);
                if (args) {
                    const phaseId = args[1];
                    const itemId = args[2];
                    if (checklistStatus[phaseId] && checklistStatus[phaseId][itemId]) {
                        el.classList.add('completed');
                    }
                }
            });
        }
        
        function resetAllProgress() {
            if (confirm("Are you sure you want to reset all progress? This action cannot be undone.")) {
                localStorage.removeItem('cpnChecklistStatus_v3');
                checklistStatus = {};
                document.querySelectorAll('.checklist-item').forEach(el => el.classList.remove('completed'));
                updateAllProgressBars();
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text.trim();
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Copied to clipboard!');
        }

        function zoomImage(src) {
            document.getElementById('modal-image-content').src = src;
            document.getElementById('image-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', renderGuide);

    </script>
</body>
</html>
